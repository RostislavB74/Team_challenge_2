{% extends "navigation/base.html" %}
{% block content %}
<style>
  /* Стилі для прокрутки і вигляду */
  .scrollable-panel {
    max-height: 500px; /* Встановіть бажану висоту */
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    background: #fff;
  }
  .table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .table th, .table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: left;
  }
  .table th {
    background-color: #f4f4f4;
    font-weight: bold;
  }
  .table tr.active {
    background-color: #e0f7fa; /* Колір підсвічування */
    font-weight: bold;
  }
  .table tr:hover {
    background-color: #f5f5f5; /* Ефект наведення */
    cursor: pointer;
  }
  .flex-container {
    display: flex;
    gap: 30px;
    margin: 20px;
  }
  .left-panel {
    width: 30%;
  }
  .right-panel {
    width: 70%;
  }
  h3 {
    margin-top: 0;
    color: #333;
  }
</style>

<div class="flex-container">
  <!-- Ліва панель: секції -->
  <div class="left-panel scrollable-panel">
    <h3>Виробничі секції</h3>
    <table id="sections" class="table">
      <thead>
        <tr>
          <th style="width: 80px;">Код</th>
          <th>Секція</th>
          <th style="width: 140px;">Цех</th>
        </tr>
      </thead>
      <tbody>
        {% for section in sections %}
        <tr class="{% if selected_section and section.id == selected_section.id %}active{% endif %}"
            data-section-id="{{ section.id }}"
            data-section-name="{{ section.name|escape }}">
          <td>{{ section.id }}</td>
          <td><a class="section-link">{{ section.name }}</a></td>
          <td>{{ section.department_id.name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Права панель: матеріали -->
  <div class="right-panel scrollable-panel">
    <h3 id="materials-title">
      Матеріали для секції: {% if selected_section %}{{ selected_section.name }}{% else %}—{% endif %}
    </h3>
    <table class="table" id="materials-table">
      <thead>
        <tr>
          <th style="width: 100px;">ID</th>
          <th>Матеріал</th>
        </tr>
      </thead>
      <tbody id="materials-body">
        {% if materials %}
          {% for m in materials %}
          <tr>
            <td>{{ m.id }}</td>
            <td>{{ m.material.name }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="2" style="color:#777; text-align:center;">Немає матеріалів</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sectionsTable = document.getElementById('sections');
  const materialsBody = document.getElementById('materials-body');
  const materialsTitle = document.getElementById('materials-title');
  const endpointTemplate = "{% url 'materials:materials_by_section_data' 0 %}";

  function loadMaterialsFor(sectionId, clickedRow) {
    const url = endpointTemplate.replace("/0/", `/${sectionId}/`);
    fetch(url, { credentials: 'same-origin' })
      .then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
      })
      .then(data => {
        // Очищення і заповнення таблиці матеріалів
        materialsBody.innerHTML = '';
        if (!data.items || data.items.length === 0) {
          materialsBody.innerHTML = '<tr><td colspan="2" style="color:#777; text-align:center;">Немає матеріалів</td></tr>';
        } else {
          data.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${escapeHtml(item.material_name)}</td>
            `;
            materialsBody.appendChild(row);
          });
        }

        // Підсвічування вибраного рядка
        sectionsTable.querySelectorAll('tbody tr').forEach(row => row.classList.remove('active'));
        if (clickedRow) clickedRow.classList.add('active');

        // Оновлення заголовку
        const sectionName = clickedRow ? clickedRow.dataset.sectionName : '—';
        materialsTitle.textContent = `Матеріали для секції: ${sectionName}`;
      })
      .catch(err => {
        console.error('Fetch error:', err);
        materialsBody.innerHTML = '<tr><td colspan="2" style="color:#777; text-align:center;">Помилка завантаження</td></tr>';
      });
  }

  // Escape HTML для безпеки
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  // Делегований обробник кліків
  sectionsTable.addEventListener('click', function (e) {
    const row = e.target.closest('tr');
    if (!row || !row.dataset.sectionId) return;
    loadMaterialsFor(row.dataset.sectionId, row);
  });

  // Завантаження матеріалів для активної секції при старті
  const activeRow = sectionsTable.querySelector('tbody tr.active');
  if (activeRow) {
    loadMaterialsFor(activeRow.dataset.sectionId, activeRow);
  }
});
</script>
{% endblock %}