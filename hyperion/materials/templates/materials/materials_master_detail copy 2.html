{% extends "navigation/base.html" %}  {# або твій base шаблон #}
{% block content %}
<div style="display: flex; gap: 30px;">
  <div style="width: 30%;">
    <h3>Виробничі секції</h3>
      <table id="sections" class="table">
        <thead>
          <tr>
            <th style="width: 80px;">Код</th>
            <th>Секція</th>
            <th style="width: 140px;">Цех</th>
          </tr>
        </thead>
        <tbody>
          {% for section in sections %}
          <tr class="{% if selected_section and section.id == selected_section.id %}active{% endif %}"
              data-section-id="{{ section.id }}"
              data-section-name="{{ section.name|escape }}">
            <td>{{ section.id }}</td>
            <td><a class="section-link">{{ section.name }}</a></td>
            <td>{{ section.department_id.name }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
</div>
  <!-- Права панель: матеріали -->
  <div style="width: 60%;">
     <h3>
  Матеріали для секції: 
  {% if selected_section %}
    {{ selected_section.name }}</h3>
    
    <div class="right-body">
      <table class="table" id="materials-table">
        <thead>
          <tr>
            <th style="width: 100px;">ID</th>
            <th>Матеріал</th>
          </tr>
        </thead>
        <tbody id="materials-body">
          {# Початково рендеримо серверно (щоб не робити зайвий запит) #}
          {% if materials %}
            {% for m in materials %}
            <tr>
              <td>{{ m.id }}</td>
              <td>{{ m.material.name }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="2" style="color:#777; text-align:center;">Немає матеріалів</td></tr>
          {% endif %}
        </tbody>
      </table>
</div>
  
{% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sectionsTable = document.getElementById('sections');
  const materialsBody = document.getElementById('materials-body');
  const materialsTitle = document.getElementById('materials-title');

  // endpoint template згенеруємо на сервері: використовуємо URL з 0, потім замінимо "0" на потрібний id
  // Переконайся, що в urls.py є ім'я 'materials:materials_by_section_data'
  const endpointTemplate = "{% url 'materials:materials_by_section_data' 0 %}";

  function loadMaterialsFor(sectionId, clickedRow) {
    const url = endpointTemplate.replace("/0/", `/${sectionId}/`); // якщо url виглядає як /.../0/data/
    fetch(url, { credentials: 'same-origin' })
      .then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
      })
      .then(data => {
        // заповнення таблиці
        if (!data.items || data.items.length === 0) {
          materialsBody.innerHTML = '<tr><td colspan="2" style="color:#777; text-align:center;">Немає матеріалів</td></tr>';
        } else {
          materialsBody.innerHTML = data.items.map(it => `
            <tr>
              <td>${it.id}</td>
              <td>${escapeHtml(it.material_name)}</td>
            </tr>
          `).join('');
        }

        // підсвічування вибраного рядка
        sectionsTable.querySelectorAll('tbody tr').forEach(r => r.classList.remove('active'));
        if (clickedRow) clickedRow.classList.add('active');

        // оновлення заголовку (беремо name з data-атрибуту)
        const sectionName = clickedRow ? clickedRow.dataset.sectionName : '';
        materialsTitle.textContent = sectionName ? `Матеріали для секції: ${sectionName}` : 'Матеріали для секції: —';

        // прокрутити матеріали вгору
        const rightBody = document.querySelector('.right-body');
        if (rightBody) rightBody.scrollTop = 0;
      })
      .catch(err => {
        console.error('Fetch error:', err);
      });
  }

  // escape для безпечного вставлення
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function (m) {
      return ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m];
    });
  }

  // Додаємо делегований обробник: натиск на будь-який tr у tbody
  sectionsTable.querySelectorAll('tbody tr').forEach(tr => {
    tr.addEventListener('click', function () {
      const sectionId = this.dataset.sectionId;
      if (!sectionId) return;
      loadMaterialsFor(sectionId, this);
    });
  });

  // — необов'язково: підвантажити на старті (якщо ти не рендериш server-side)
  // Якщо хочеш підвантажити на старті (в разі, коли materials пусті на сервері), розкоментуй:
  
  const activeRow = sectionsTable.querySelector('tbody tr.active');
  if (activeRow) {
    loadMaterialsFor(activeRow.dataset.sectionId, activeRow);
  }
  
});
</script>
{% endblock %}
