{% extends "navigation/base.html" %}
{% block content %}
<style>
  .scrollable-panel {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    background: #f9f9f9;
  }
  .table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-top: 10px;
  }
  .table th, .table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
  }
  .table th {
    background-color: #e0e0e0;
    font-weight: 600;
  }
  .table tr.active {
    background-color: #b3e5fc;
    font-weight: 500;
  }
  .table tr:hover {
    background-color: #f0f0f0;
    cursor: pointer;
  }
  .flex-container {
    display: flex;
    gap: 20px;
    margin: 20px;
    padding: 10px;
  }
  .left-panel {
    width: 35%;
  }
  .right-panel {
    width: 60%;
  }
  h3 {
    margin: 0 0 10px 0;
    color: #222;
    font-size: 18px;
  }
  .loading {
    color: #777;
    text-align: center;
    padding: 20px;
  }
  .pagination {
    margin-top: 10px;
    text-align: center;
  }
  .pagination a {
    margin: 0 5px;
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    text-decoration: none;
    color: #333;
  }
  .pagination a.active {
    background-color: #b3e5fc;
    border-color: #0288d1;
  }
</style>

<div class="flex-container">
  <!-- Ліва панель: цехи -->
  <div class="scrollable-panel">
    <h3>Групи виробничих ліній</h3>
    <table id="departments" class="table">
      <thead>
        <tr>
          <th style="width: 100px;">Код</th>
          <th>Група</th>
          <th style="width: 240px;">Декор</th>
          <th style="width: 240px;">Основне виробництво</th>
          <th style="width: 180px;">Порядок</th>
        </tr>
      </thead>
      <tbody>
        {% for groups in page_obj %}
                    <tr>
                        <td>{{ groups.id|default:"-" }}</td>
                        <td>{{ groups.name|default:"-" }}</td>
                        <td>{% if groups.decor %}✅{% endif %}</td>
                        <td>{% if groups.base %}✅{% endif %}</td>
                        <td>{{ groups.order|default:"-" }}</td>
                        
                    </tr>
                    {% endfor %}
      </tbody>
    </table>
  </div>

  {% comment %} <!-- Права панель: дільниці -->
  <div class="right-panel scrollable-panel">
    <h3 id="sections-title">
      Дільниці для цеху: {% if selected_department %}{{ selected_department.name }}{% else %}—{% endif %}
    </h3>
    <table class="table" id="sections-table">
      <thead>
        <tr>
          <th style="width: 100px;">ID</th>
          <th>Дільниця</th>
          <th>Опис</th>
          <th style="width: 80px;">Номер</th>
        </tr>
      </thead>
      <tbody id="sections-body">
        {% if sections %}
          {% for s in sections %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.descriptions|default:"—" }}</td>
            <td>{{ s.num|default:"—" }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" class="loading">Немає дільниць</td></tr>
        {% endif %}
      </tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>
</div> {% endcomment %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const departmentsTable = document.getElementById('departments');
  const sectionsBody = document.getElementById('sections-body');
  const sectionsTitle = document.getElementById('sections-title');
  const paginationDiv = document.getElementById('pagination');
  const endpointTemplate = "{% url 'productions:sections_by_department_data' 0 %}";

  function loadSectionsFor(departmentId, clickedRow, page = 1) {
    sectionsBody.innerHTML = '<tr><td colspan="4" class="loading">Завантаження...</td></tr>';
    const url = endpointTemplate.replace("/0/", `/${departmentId}/`) + `?page=${page}`;
    fetch(url, { credentials: 'same-origin' })
      .then(resp => {
        if (!resp.ok) throw new Error('Network response was not ok');
        return resp.json();
      })
      .then(data => {
        sectionsBody.innerHTML = '';
        if (!data.items || data.items.length === 0) {
          sectionsBody.innerHTML = '<tr><td colspan="4" class="loading">Немає дільниць</td></tr>';
        } else {
          data.items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.id}</td>
              <td>${escapeHtml(item.section_name)}</td>
              <td>${escapeHtml(item.description)}</td>
              <td>${item.num || '—'}</td>
            `;
            sectionsBody.appendChild(row);
          });
        }

        departmentsTable.querySelectorAll('tbody tr').forEach(row => row.classList.remove('active'));
        if (clickedRow) clickedRow.classList.add('active');

        const departmentName = clickedRow ? clickedRow.dataset.departmentName : '—';
        sectionsTitle.textContent = `Дільниці для цеху: ${departmentName}`;

        // Пагінація
        paginationDiv.innerHTML = '';
        if (data.has_next) {
          const nextLink = document.createElement('a');
          nextLink.textContent = 'Наступна';
          nextLink.href = '#';
          nextLink.addEventListener('click', (e) => {
            e.preventDefault();
            loadSectionsFor(departmentId, clickedRow, parseInt(data.page) + 1);
          });
          paginationDiv.appendChild(nextLink);
        }
        if (data.page > 1) {
          const prevLink = document.createElement('a');
          prevLink.textContent = 'Попередня';
          prevLink.href = '#';
          prevLink.addEventListener('click', (e) => {
            e.preventDefault();
            loadSectionsFor(departmentId, clickedRow, parseInt(data.page) - 1);
          });
          paginationDiv.appendChild(prevLink);
        }
      })
      .catch(err => {
        console.error('Fetch error:', err);
        sectionsBody.innerHTML = '<tr><td colspan="4" class="loading">Помилка завантаження</td></tr>';
      });
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  departmentsTable.addEventListener('click', function (e) {
    const row = e.target.closest('tr');
    if (!row || !row.dataset.departmentId) return;
    loadSectionsFor(row.dataset.departmentId, row);
  });

  const activeRow = departmentsTable.querySelector('tbody tr.active');
  if (activeRow) {
    loadSectionsFor(activeRow.dataset.departmentId, activeRow);
  }
});
</script>
{% endblock %}